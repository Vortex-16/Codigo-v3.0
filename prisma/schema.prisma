// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
    provider = "prisma-client-js"
    output   = "../generated/prisma"
}

datasource db {
    provider = "mongodb"
    url      = env("DATABASE_URL")
}

// NextAuth Models (MongoDB compatible)
model Account {
    id                       String  @id @default(auto()) @map("_id") @db.ObjectId
    userId                   String  @db.ObjectId
    type                     String
    provider                 String
    providerAccountId        String
    refresh_token            String?
    access_token             String?
    expires_at               Int?
    token_type               String?
    scope                    String?
    id_token                 String?
    session_state            String?
    user                     User    @relation(fields: [userId], references: [id], onDelete: Cascade)
    refresh_token_expires_in Int?

    @@unique([provider, providerAccountId])
    @@map("accounts")
}

model Session {
    id           String   @id @default(auto()) @map("_id") @db.ObjectId
    sessionToken String   @unique
    userId       String   @db.ObjectId
    expires      DateTime
    user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@map("sessions")
}

model User {
    id            String    @id @default(auto()) @map("_id") @db.ObjectId
    name          String?
    email         String?   @unique
    emailVerified DateTime?
    image         String?
    
    // CodeBattle Arena specific fields
    rank              Int      @default(0)
    contestsCount     Int      @default(0)
    streakCount       Int      @default(0)
    lastSolvedDate    DateTime?
    problemsSolved    Int      @default(0)
    easyCount         Int      @default(0)
    mediumCount       Int      @default(0)
    hardCount         Int      @default(0)
    realWorldCount    Int      @default(0)
    
    // Arena stats
    arenaWins         Int      @default(0)
    arenaLosses       Int      @default(0)
    arenaTotalMatches Int      @default(0)
    arenaRating       Int      @default(1000)
    arenaWinStreak    Int      @default(0)
    arenaBestStreak   Int      @default(0)
    
    accounts          Account[]
    sessions          Session[]
    solvedProblems    SolvedProblem[]
    player1Matches    ArenaMatch[] @relation("player1Matches")
    player2Matches    ArenaMatch[] @relation("player2Matches")
    
    @@map("users")
}

model VerificationToken {
    id         String   @id @default(auto()) @map("_id") @db.ObjectId
    identifier String
    token      String   @unique
    expires    DateTime

    @@unique([identifier, token])
    @@map("verification_tokens")
}

// CodeBattle Arena Models
model Problem {
    id          String   @id @default(auto()) @map("_id") @db.ObjectId
    problemId   String   @unique
    title       String
    description String
    difficulty  String
    category    String
    timeLimit   Int      @default(300) // seconds
    testCases   Json     // Array of test cases
    starterCode Json     // Starter code for different languages
    solution    String?  // Optional solution
    hints       Json?    // Optional hints array
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt
    
    solvedBy    SolvedProblem[]
    
    @@map("problems")
}

model SolvedProblem {
    id         String   @id @default(auto()) @map("_id") @db.ObjectId
    userId     String   @db.ObjectId
    problemId  String   @db.ObjectId
    difficulty String
    language   String
    code       String
    solvedAt   DateTime @default(now())
    
    user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
    problem    Problem  @relation(fields: [problemId], references: [id], onDelete: Cascade)
    
    @@unique([userId, problemId])
    @@map("solved_problems")
}

model ArenaMatch {
    id          String   @id @default(auto()) @map("_id") @db.ObjectId
    matchId     String   @unique
    player1Id   String   @db.ObjectId
    player2Id   String   @db.ObjectId
    difficulty  String
    status      String   @default("waiting") // waiting, ready, active, completed, abandoned
    winnerId    String?  @db.ObjectId
    
    player1Score     Int      @default(0)
    player2Score     Int      @default(0)
    player1Progress  Int      @default(0)
    player2Progress  Int      @default(0)
    
    problems    Json     // Array of problem IDs
    results     Json?    // Match results/history
    
    createdAt   DateTime @default(now())
    startedAt   DateTime?
    completedAt DateTime?
    
    player1     User     @relation(fields: [player1Id], references: [id], name: "player1Matches")
    player2     User     @relation(fields: [player2Id], references: [id], name: "player2Matches")
    
    @@map("arena_matches")
}

model ArenaQueue {
    id         String   @id @default(auto()) @map("_id") @db.ObjectId
    userId     String   @db.ObjectId
    username   String
    difficulty String
    joinedAt   DateTime @default(now())
    
    @@map("arena_queue")
}
